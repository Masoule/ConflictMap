<!DOCTYPE html>
<html>

  <head>
  	<title>D3 Mapping Timeline</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="style.css" />

  </head>

    <body>
      <script src="http://d3js.org/d3.v4.min.js"></script>
      <script src="http://d3js.org/topojson.v2.min.js"></script>
      <script src="https://d3js.org/d3-geo.v1.min.js"></script>
      <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
      <script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
      <script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>
      <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <!-- <script src="/datamaps.world.min.js"></script> -->
      <!-- <script src="node_modules/datamaps/dist/datamaps.world.min.js"></script> -->
      <script src="../src/main.js"></script>
      <script src="../src/plot.js"></script>

      <script>
      var color_na = d3.rgb("#d4d4d4");
      var quantiles = [0, 0.2, 0.4, 0.6, 0.8, 1];
      var start_year = 1990;
      var headline = "Number of casualties";
      var mapPath = "worldMap.json";

      //map element
      var width = 960,
          height = 600;

      var svg = d3.select("body").insert("svg")
        .attr("id", "map")
        .attr("height", height)
        .attr("width", width);

      var projection = d3.geoRobinson()
        .translate([width / 2, height / 2]);

      var path = d3.geoPath(d3.geoRobinson().translate([width / 2, height / 2]));
      //alternative rectangular map
      // var path = d3.geoPath(d3.geoEquirectangular().translate([width / 2, height / 2]));

      //alternative online map
      // var mapPath = "https://unpkg.com/world-atlas@1/world/110m.json";

      // slider element
      d3.select("body").insert("p").append("input")
        .attr("type", "range")
        .attr("min", "1990")
        .attr("max", "2016")
        .attr("value", start_year)
        .attr("id", "slider");

      d3.select("body").insert("h2", ":first-child").text(headline + start_year);

      //plot element
      var margin = {top: 50, right:10, bottom:50, left:30},
          plotWidth = 960 - margin.left - margin.right,
          plotHeight = 300 - margin.top - margin.bottom;

      var x = d3.scaleTime()
            .rangeRound([0, plotWidth]);

      var y = d3.scaleLinear()
            .rangeRound([plotHeight, 0]);

      var plot = d3.select("body")
          .append("svg")
            .attr("id", "plot")
            .attr("width", plotWidth + margin.left + margin.right)
            .attr("height", plotHeight + margin.top + margin.bottom)
          .append("g")
            .attr("class", "plot")
            .attr("transform", "translate(" + margin.left + ", " + margin.top + ")");

      //load data
      d3.json("yearly.json", function(error, d) {
        if (error) throw error;
        let data_all = d['killed'];
        let data = data_all[start_year];
        let color = colorGradient(data);
        // console.log(data)

        // load map data
        d3.json(mapPath, function(error, worldmap) {
          if (error) throw error;
          //adds colors
          svg.append("g")
            .attr("class", "countries")
            .selectAll("path")
            .data(topojson.feature(worldmap, worldmap.objects.world).features)
            .enter().append("path")
              .attr("d", path)
              .attr("id", function(d) { return d.id; })
              .call(fillMap, color, data)
            .append("title")
              .call(setPathTitle, data);

          //add circles
          svg.append("g")
            .attr("class", "circles")
            .selectAll("circle")
            .data(topojson.feature(worldmap, worldmap.objects.world).features)
            .enter().append("circle")
              .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; })
              .call(addCircle, data)

          //add plot
          renderPlot();
          // renderPlot(start_year);
        }); // map

        // update with slider input
        d3.select("#slider").on("input", function() {
            let new_color = colorGradient(data_all[this.value]);
            updateMap(new_color, data_all[this.value]);
            // renderPlot(this.value);
        });

        // document.getElementById('year').addEventListener('input', function(e) {
        //   var year = parseInt(e.target.value, 10);
        //   filterBy(year);
        // });

      }); //data

      </script>
      <script src="bundle.js"></script>

    </body>

</html>
