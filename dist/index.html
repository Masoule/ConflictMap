<!DOCTYPE html>
<html>

  <head>
  	<title>D3 Mapping Timeline</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="./style.css" />

  </head>

    <body>
      <script src="http://d3js.org/d3.v4.min.js"></script>
      <script src="http://d3js.org/topojson.v2.min.js"></script>
      <script src="https://d3js.org/d3-geo.v1.min.js"></script>
      <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
      <script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
      <script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>
      <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <!-- <script src="/datamaps.world.min.js"></script> -->
      <!-- <script src="node_modules/datamaps/dist/datamaps.world.min.js"></script> -->
      <script src="../src/main.js"></script>
      <script src="../src/plot.js"></script>
      <script src="../src/map.js"></script>

      <script>
      var default_color = d3.rgb("#f7f7f7");
      var quantiles = [0, 0.2, 0.4, 0.6, 0.8, 1];
      var start_year = 1400;
      // var headline = "Number of casualties";
      var mapPath = "worldMap.json";

      //map element
      var width = (window.innerWidth) * 0.9,
          height = (window.innerHeight) * 0.7;

      var svg = d3.select("body").insert("svg")
        .attr("id", "map")
        .attr("height", height)
        .attr("width", width);

      var projection = d3.geoRobinson()
        .translate([width / 2, height / 2]);

      var path = d3.geoPath(d3.geoRobinson().translate([width / 2, height / 2]));
      //alternative rectangular map
      // var path = d3.geoPath(d3.geoEquirectangular().translate([width / 2, height / 2]));

      //alternative online map
      // var mapPath = "https://unpkg.com/world-atlas@1/world/110m.json";

      //tooltip
      var div = d3.select("body")
      .append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

      //plot element
      d3.select("body").insert("p")
      //headline
      d3.select("body p").insert("h1", ":first-child")
        .text("Human Casualties of War");
      d3.select("body p").insert("h2")

      var margin =
          {top: (window.innerHeight) * 0.1, right:10, bottom:0, left:10},
          plotWidth = width - margin.left - margin.right,
          plotHeight = (window.innerHeight) * 0.4 - margin.top - margin.bottom;

      var x = d3.scaleLinear()
            .rangeRound([0, plotWidth]),
          y = d3.scaleLinear()
            .rangeRound([plotHeight, 0]);

      var plot = d3.select("p")
          .append("svg")
            .attr("id", "plot")
            .attr("width", plotWidth + margin.left + margin.right)
            .attr("height", plotHeight + margin.top + margin.bottom)
          .append("g")
            .attr("class", "plot")
            .attr("transform", "translate(" + margin.left + ", " + margin.top + ")");

      // slider element
      d3.select("p").append("input")
        .attr("type", "range")
        .attr("min", "1400")
        .attr("max", "2000")
        .attr("value", start_year)
        .attr("id", "slider")
        .style("width", width + "px")

      //find country id's to find the location on map
      var rawMapData
      var country_to_id

      d3.csv("../data/country_to_id.csv", function(ids) {
        country_to_id = ids
      })

      //load map data
      d3.csv("../data/map_data.csv", function(csv) {
        rawMapData = csv.map( d => {
          d.killed = +d.killed
          d.year = +d.year
          d.duration = +d.duration
          d.name = d.name
          d.country = d.country.trim()
          var id_array = country_to_id.filter(dd => d.country === dd.country )
          d.id = id_array.length ? id_array[0].id : 'X'
          d.description = d.description
          return d
        })

        let data = filterMapData(rawMapData, start_year)
        let color = colorGradient(data);
        // load map
        initializeMap(data, color)
        //add plot
        renderPlot(start_year);

        // update with slider input
        d3.select("#slider").on("input", function() {
            console.log(this.value)
            let selectedYear = this.value;
            let newData = filterMapData(rawMapData, selectedYear)
            let newColor = colorGradient(newData);
            updateMap(newColor, newData);
            renderPlot(selectedYear);
        });

      }); //data

      </script>
      <script src="bundle.js"></script>

    </body>

</html>
